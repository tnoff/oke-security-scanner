name: CD

on:
  pull_request:
    types:
    - closed

jobs:
  tag_build:
    permissions:
      contents: write
    uses: tnoff/github-workflows/.github/workflows/tag.yml@f1ccc6f7845e103773faa0c4f1a61b7feeeddc10
    with:
      version_file: ./VERSION
  check_labels:
    permissions:
      contents: read
      pull-requests: read
    uses: tnoff/github-workflows/.github/workflows/check-pr-labels.yml@f1ccc6f7845e103773faa0c4f1a61b7feeeddc10
    with:
      required_labels: 'build-docker'
      require_all_labels: true
      require_merged: true
  build:
    permissions:
      contents: read
    needs: check_labels
    if: needs.check_labels.outputs.conditions_met == 'true'
    uses: tnoff/github-workflows/.github/workflows/ocir-push.yml@f1ccc6f7845e103773faa0c4f1a61b7feeeddc10
    with:
      image_name: ${{ vars.OCI_REPO_NAME }}
      platforms: linux/amd64,linux/arm64
    secrets:
      oci_registry: ${{ secrets.OCI_REGISTRY }}
      oci_username: ${{ secrets.OCI_USERNAME }}
      oci_token: ${{ secrets.OCI_TOKEN }}
      oci_namespace: ${{ secrets.OCI_NAMESPACE }}